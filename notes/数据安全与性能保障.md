### 持久化选项
- 快照  
将存在于某一个时刻的所有数据写入磁盘  
- 只追加文件(AOF  append only file)  
在命令执行的时候，将命令写入磁盘
```text
这两种方案可以同时使用，也可以单独使用。具体的持久化方式，需要根据应用和存储的数据确定
```

#### 快照持久化
```text
创建快照来获取存储在内存的数据在某个时间的副本。可以对副本备份，复制给他的服务器，或者用在重启服务器的时候
使用。
如果在新建的快照文件创建好之前，Redis，系统或者硬件某一个崩溃，那么将会丢失最近一次创建快照之后写入的所有数据。

创建快照的几种方式
1. 发送bgsave命令创建快照, fork一个进程进行创建，而主进程依然在处理请求
2. 发送save命令创建快照，此时redis不再处理任何其他的请求。只有在没有足够的内存去执行besave，才会调用
3. 当配置了 save 60 1000(count), 当60秒内完成了1000次的数据写入需求，出发bgsave操作。
4. redis通过shutdown收到结束进程的请求会执行save，同时不再处理其他的请求
5. 一个redis连接另一个redis发送sync的命令，如果此时主服务器没有执行bgsave或者并非刚执行完bgsave，就需要执行了。

快照适用于那些可以接受部分是应用数据丢失的程序。
```

#### 大数据
```text
当redis的数据仅有几G的时候，使用快照保存数据是没有问题的。当redis占用的内存越来越多，redis创建子进程
需要的时间也会越来越多。如果redis运行在虚拟机上，可能会导致使用大量的虚拟内存，导致redis性能降低
甚至无法使用。
为了防止redis因为创建子进程而出现卡顿，可以考虑关闭自动保存，采取手动发送bgsave或者save进行持久化。
手动依然是出现redis的卡顿，但是控制了卡顿出现的时间(自己在空闲(深夜)时间跑)，save则是阻塞redis再去
处理其他的请求，没有子进程在争抢资源。所以save命令创建的会更快一些。
```

#### AOF持久化
简单来说，AOF就是将执行的命令写到AOF文件的结尾，以此来记录redis数据发生的变化。redis只要在从头执行一遍
AOF文件记录的命令，既可以恢复AOF记录的数据。

###### 文件同步
```text
向磁盘写入文件时，至少会发生三件事，内容会先被写入到缓冲区，在某个时间系统冲洗缓冲区，数据写入到磁盘。
或者调用flush进行冲洗，但是什么时候写入还是操作系统决定。除此之外，用户可以指定操作系统将文件同步(sync)到磁盘
同步会一直阻塞，直到文件写入磁盘，执行同步后，即使系统出现故障，也不会对同步的文件造成任何影响。
```

| 选项 | 同步频率 |
| :----: | :----: |
| always |  每个redis命令都写入磁盘，这样会严重的影响redis的速度 |
| everysec | 每秒同步一次，将多次的命令同步到磁盘 |
| no | 让操作系统决定什么时候同步 |

> 固态硬盘 谨慎使用 appendfsync always，这种不断写入少量数据可能带来`写入放大`的问题。降低固态硬盘的寿命。
> 可以考虑everysec的写入频率，这样出现故障也是丢失一秒内产生的数据。
> 若果是no选项，redis出现故障，丢失的数据是不可控的。如果磁盘处理写频率不够快的话，缓冲区被等待写入磁盘的数据
> 填满，redis的写入操作会被阻塞，将会降低redis的处理速度。
> 最后要注意AOF文件的大小

#### 复制
启动redis指定`slaveof host port`的配置选项，就会主动去连接主服务器，发送`slaveof no one`命令停止从主服务器接受复制操作

###### 从服务器连接到主服务器的步骤
| 步骤 | 主服务器操作 | 从服务器操作 |
| :----: | :----: | :----: |
| 1 | 等待命令写入 | 连接到主服务器，发送sync命令 |
| 2 | 执行bgsave命令，并利用缓冲区记录执行bgsave后执行的所有命令 | 根据配置觉得继续使用现有数据处理客户端请求，还是直接拒绝 |
| 3 | 执行完bgsave，发送快照给从服务器，发送期间还是继续利用缓冲区记录进来的命令 | 丢弃原来的数据，开始载入快照数据 |
| 4 | 发送缓冲区记录的数据 | 完成载入后，开始正常处理请求 |
| 5 | 缓冲区数据发送完成后，以后每执行一个命令都直接发送给从服务器 | 处理完成缓冲区数据，开始接受并执行主服务器发来的每个命令 |

> **从服务器在进行同步的时候，会清空原有的所有数据**。所以在服务器做从服务器的时候，注意原数据的处理。避免数据的丢失。
> 不能支持主主复制，两个redis持续占用大量资源与对方通信。客户端可能会得到不一致的数据，甚至得不到数据。

###### 主从链
当一个主服务器有多个从服务器的时候，多个同步可能会导致主服务器难以在处理请求。所以考虑`主从链`。从服务器也可以有自己的从服务器
`从服务器对从服务器的复制`与`主服务器对从服务器的复制`的唯一区别是：从对从在发送完快照后，发送存储区的数据的时候
将会断开连接，从服务器需要重新与父级从服务器进行连接进行同步

###### 验证快照和AOF文件
快照持久化和AOF持久化都提供了验证工具`redis-check-aof, redis-check-dump`。

###### 更换故障主服务器
A，B两个redis服务器是主从关系，B是A的从服务器，A机器挂了，可以采取两种方式
1. 在B执行save命令得到快照，复制给C，然后B在做C的从服务器
2. B做主服务器，然后C做B的从服务器

#### 事务
见translation代码

#### 性能方面注意事项
```shell script
redis-benchmark -c 1 -q #测试各项命令性能
```


